<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digimon 2E â€” Character Sheet (Single File)</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070a12;
      --panel:#0e1424;
      --panel-2:#111a2f;
      --ink:#c6f7ff;
      --muted:#7fd1e3;
      --accent:#00eaff;
      --accent-2:#6cf0ff;
      --danger:#ff3b6b;
      --ok:#00f59d;
      --warn:#ffd166;
      --grid:rgba(0,234,255,0.07);
      --shadow:0 6px 18px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(108,240,255,0.05);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:radial-gradient(1200px 800px at 80% -10%, rgba(0,234,255,0.12), transparent 60%),
      linear-gradient(180deg, #060913 0%, #0a1020 100%);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji',sans-serif;
    }
    .grid-bg::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0; background:
        linear-gradient(to right, var(--grid) 1px, transparent 1px) 0 0/40px 40px,
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px) 0 0/40px 40px; 
      mask: radial-gradient(ellipse at 50% 20%, rgba(255,255,255,0.8), transparent 70%);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:1px solid rgba(108,240,255,0.25);
      background:rgba(7,10,18,0.7);
    }
    .brand{font-family:Orbitron, sans-serif; font-weight:800; letter-spacing:0.08em; color:var(--accent); text-shadow:0 0 12px rgba(0,234,255,0.4)}
    .spacer{flex:1}
    .btn{
      --ring:0 0 0 0 rgba(0,234,255,0.35);
      display:inline-flex; align-items:center; gap:.55rem; border:1px solid rgba(108,240,255,0.35); color:var(--ink);
      background:linear-gradient(180deg, var(--panel-2), var(--panel)); box-shadow:var(--shadow);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s ease transform, .15s ease box-shadow, .15s ease filter;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,234,255,0.15), inset 0 0 0 1px rgba(108,240,255,0.15) }
    .btn.primary{ border-color: rgba(0,245,157,0.45); color:#eafff7 }
    .btn.danger{ border-color: rgba(255,59,107,0.45); color:#ffeaf0 }

    .container{ max-width:1200px; margin:18px auto; padding:0 16px; position:relative; z-index:1 }

    /* Tabs */
    .tabs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:14px 0 }
    .tab{
      display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid rgba(108,240,255,0.25); background:var(--panel);
      cursor:pointer; user-select:none; box-shadow:var(--shadow)
    }
    .tab.active{ outline:2px solid rgba(0,234,255,0.5); background:linear-gradient(180deg, #0d1930, #0c1430) }
    .tab .close{ opacity:.8; font-weight:800; padding:0 6px; border-radius:8px }
    .tab .close:hover{ background:rgba(255,255,255,0.08) }

    .sheets{ position:relative }
    .sheet{ display:none }
    .sheet.active{ display:block }

    h2.section-title{
      font-family:Orbitron, sans-serif; letter-spacing:.08em; font-weight:700; margin:24px 0 12px; color:var(--accent-2)
    }
    .panel{
      background:linear-gradient(180deg, var(--panel-2), var(--panel)); border:1px solid rgba(108,240,255,0.25); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
    }

    /* Form grid */
    .grid{ display:grid; gap:12px }
    .g-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
    .g-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }
    .g-4{ grid-template-columns: repeat(4, minmax(0,1fr)) }
    .g-5{ grid-template-columns: repeat(5, minmax(0,1fr)) }
    @media (max-width: 900px){ .g-4{ grid-template-columns: repeat(2, minmax(0,1fr)) } }
    @media (max-width: 720px){ .g-3,.g-5{ grid-template-columns: repeat(2, minmax(0,1fr)) } }

    label{ display:flex; flex-direction:column; gap:6px; font-size:.9rem; color:var(--muted) }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(108,240,255,0.35);
      background:#0a1222; color:var(--ink); outline:none; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.2);
    }
    input[type="number"]{ -moz-appearance:textfield }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .kpi{ display:flex; align-items:baseline; gap:10px; font-family:Orbitron, sans-serif }
    .kpi .value{ font-size:1.6rem; font-weight:800; color:#eaffff; text-shadow:0 0 12px rgba(0,234,255,0.35) }
    .muted{ color:var(--muted); font-size:.88rem }
    .row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }

    /* Stat cards */
    .stat-card{ background:#0a1222; border:1px solid rgba(108,240,255,0.25); border-radius:16px; padding:12px; display:flex; flex-direction:column; gap:8px }
    .stat-name{ font-family:Orbitron, sans-serif; color:var(--accent-2); letter-spacing:.06em; font-size:.9rem }
    .stat-total{ text-align:center; font-size:1.6rem; font-family:Orbitron, sans-serif; font-weight:800; padding:4px 0 }
    .tiny{ font-size:.8rem; color:var(--muted) }

    /* Attacks */
    .attack-row{ display:grid; grid-template-columns: 1.2fr .9fr .9fr .6fr .6fr .9fr .9fr .9fr auto; gap:8px; align-items:end }
    @media (max-width: 1000px){ .attack-row{ grid-template-columns: 1.2fr .9fr .9fr .6fr .6fr .9fr .9fr; } }
    @media (max-width: 760px){ .attack-row{ grid-template-columns: 1.2fr .9fr .9fr .6fr .6fr; } }
    .attack-row .x{ align-self:center }
    .taglabel{ display:flex; gap:6px }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px dashed rgba(108,240,255,0.4); color:var(--muted); background:#0a1222 }

    .fraction{ font-family:Orbitron, sans-serif; display:inline-flex; flex-direction:column; align-items:center; line-height:1 }
    .fraction .num{ border-bottom:1px solid rgba(108,240,255,0.4); width:100%; text-align:center; padding:0 6px; }

    .note{ font-size:.85rem; color:var(--muted) }

    /* Modals */
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,8,20,0.6); z-index:30 }
    .hidden{ display:none !important }
    .modal .box{ width:min(640px, 96vw); background:linear-gradient(180deg, #0d1830, #0b1430); border:1px solid rgba(108,240,255,0.35); border-radius:16px; padding:16px; box-shadow:var(--shadow) }
    .modal h3{ margin:0 0 10px; font-family:Orbitron, sans-serif }

    .help{ color:var(--muted); font-size:.9rem }
    .hr{ height:1px; background:rgba(108,240,255,0.2); margin:12px 0 }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <header>
    <div class="brand">DIGIMON 2E â€” CHARACTER SHEETS</div>
    <div class="spacer"></div>
    <button class="btn" id="newBtn" title="Create new sheet">âž• New</button>
    <button class="btn" id="saveBtn" title="Save active sheet">ðŸ’¾ Save</button>
    <button class="btn" id="openBtn" title="Open saved sheet">ðŸ“‚ Open</button>
  </header>

  <div class="container">
    <div class="tabs" id="tabBar"></div>
    <div class="sheets" id="sheets"></div>
  </div>

  <!-- New Modal -->
  <div class="modal hidden" id="newModal">
    <div class="box">
      <h3>Create New Sheet</h3>
      <div class="row" style="margin:10px 0 14px">
        <button class="btn" data-newtype="tamer">Tamer (coming soon)</button>
        <button class="btn primary" data-newtype="digimon">Digimon</button>
      </div>
      <div class="help">Choose sheet type. A new tab will be added below the toolbar.</div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" id="closeNew">Close</button>
      </div>
    </div>
  </div>

  <!-- Open Modal -->
  <div class="modal hidden" id="openModal">
    <div class="box">
      <h3>Open Saved Sheets</h3>
      <div id="openList" class="grid g-2"></div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button class="btn" id="closeOpen">Close</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const tabBar = document.getElementById('tabBar');
  const sheets = document.getElementById('sheets');
  const newBtn = document.getElementById('newBtn');
  const saveBtn = document.getElementById('saveBtn');
  const openBtn = document.getElementById('openBtn');
  const newModal = document.getElementById('newModal');
  const openModal = document.getElementById('openModal');
  const closeNew = document.getElementById('closeNew');
  const closeOpen = document.getElementById('closeOpen');
  const openList = document.getElementById('openList');

  const STAGE_MAP = { 'Child':2, 'Adult':3, 'Perfect':4, 'Ultimate':5 };
  const SIZE_BONUS = (size)=>{
    if(!size) return {BIT:0,RAM:0,DOS:0,CPU:0};
    const s = String(size).toLowerCase();
    if(s==='small' || s==='medium') return {BIT:1,RAM:1,DOS:0,CPU:0};
    if(s==='large') return {BIT:1,RAM:0,DOS:0,CPU:1};
    // huge / enormous / gigantic
    return {BIT:0,RAM:0,DOS:1,CPU:1};
  };

  const uid = ()=> 'id_'+Math.random().toString(36).slice(2,10);

  const state = { tabs:[], active:null };

  function activateTab(id){
    state.active = id;
    [...tabBar.children].forEach(el=> el.classList.toggle('active', el.dataset.id===id));
    [...sheets.children].forEach(el=> el.classList.toggle('active', el.dataset.id===id));
  }

  // Small helper builders used inside templates
  function textField(label, path, placeholder=''){
    return `<label>${label}<input type="text" data-bind="${path}" placeholder="${placeholder}" /></label>`;
  }
  function numberField(label, path, opts={}){
    const step = opts.step ?? 1;
    const min = (typeof opts.min!=='undefined') ? ` min="${opts.min}"` : '';
    return `<label>${label}<input type="number" step="${step}"${min} data-bind="${path}" /></label>`;
  }
  function selectField(label, path, options){
    return `<label>${label}<select data-bind="${path}">${options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></label>`;
  }

  function addTab(title, type='digimon', data=null){
    const id = uid();
    const tab = document.createElement('div');
    tab.className = 'tab active';
    tab.dataset.id = id;
    tab.innerHTML = `<span>ðŸ“„ ${title}</span><span class="close" title="Close">âœ•</span>`;
    tab.onclick = (e)=>{
      if(e.target.classList.contains('close')){
        const sheet = document.querySelector(`.sheet[data-id="${id}"]`);
        sheet?.remove(); tab.remove();
        const idx = state.tabs.findIndex(t=>t.id===id);
        if(idx>-1) state.tabs.splice(idx,1);
        if(state.active===id){
          const fallback = tabBar.querySelector('.tab');
          if(fallback) activateTab(fallback.dataset.id);
        }
        return;
      }
      activateTab(id);
    };
    // deactivate others
    [...tabBar.children].forEach(el=> el.classList.remove('active'));
    tabBar.appendChild(tab);

    const sheet = document.createElement('div');
    sheet.className = 'sheet active';
    sheet.dataset.id = id;

    if(type==='digimon'){
      sheet.appendChild(renderDigimonSheet(id, data));
    } else {
      const coming = document.createElement('div');
      coming.className = 'panel';
      coming.innerHTML = `<h2 class="section-title">Tamer Sheet</h2><div class="help">Coming soon âœ¨</div>`;
      sheet.appendChild(coming);
    }

    [...sheets.children].forEach(el=> el.classList.remove('active'));
    sheets.appendChild(sheet);

    state.tabs.push({id, title, type});
    activateTab(id);
    return id;
  }

  function renderDigimonSheet(id, data){
    // data default
    data = data || {
      meta:{ name:'', digimon:'', type:'', attribute:'Vaccine', stage:'Child', size:'Medium' },
      combat:{ woundBoxes:0, tempWounds:0, batteryManual:0 },
      stats:{ ACC:{dp:0, bonus:0}, DOD:{dp:0, bonus:0}, DAM:{dp:0, bonus:0}, ARM:{dp:0, bonus:0}, HP:{dp:0, bonus:0} },
      derived:{ BIT:{bonus:0}, RAM:{bonus:0}, DOS:{bonus:0}, CPU:{bonus:0} },
      attacks:[ {name:'', range:'Melee', type:'Damage', acc:0, dmg:0, tags:['','','']} ],
      dp:{ quality:0, bonus:0 },
      qualities: ''
    };

    // helpers
    const stageValue = ()=> STAGE_MAP[String(data.meta.stage)]||1;
    const statTotal = (k)=> (stageValue()) + (Number(data.stats[k].dp)||0) + (Number(data.stats[k].bonus)||0);
    const derivedBase = { BIT:'ACC', RAM:'DOD', DOS:'DAM', CPU:'ARM' };
    const derivedTotal = (k)=> {
      const baseKey = derivedBase[k];
      const base = statTotal(baseKey);
      let total = Math.floor(base/3) + (Number(data.derived[k].bonus)||0);
      const sizeB = SIZE_BONUS(data.meta.size);
      total += sizeB[k]||0;
      return total;
    };
    const woundTotal = ()=> (statTotal('HP')*2) - (Number(data.stats.HP.bonus)||0);
    const batteryTotal = ()=> stageValue() + 1;
    const statDPSum = ()=> ['ACC','DOD','DAM','ARM','HP'].reduce((s,k)=> s + (Number(data.stats[k].dp)||0), 0);
    const spentDP = ()=> (Number(data.dp.quality)||0) + statDPSum();
    const totalAllocDP = ()=> (stageValue()*10) + (Number(data.dp.bonus)||0);

    const root = document.createElement('div');

    // Basic Info
    root.appendChild(el(`
      <section class="panel">
        <h2 class="section-title">Basic Info</h2>
        <div class="grid g-3">
          ${textField('Name','meta.name')}
          ${textField('Digimon','meta.digimon')}
          ${textField('Type','meta.type')}
          ${selectField('Attribute','meta.attribute',['Vaccine','Data','Virus'])}
          ${selectField('Stage','meta.stage',['Child','Adult','Perfect','Ultimate'])}
          ${selectField('Size','meta.size',['Small','Medium','Large','Huge','Enormous','Gigantic'])}
        </div>
        <div class="note" style="margin-top:8px">Stage value: Child=1, Adult=2, Perfect=3, Ultimate=4</div>
      </section>
    `));

    // Combat
    const combatPanel = el(`
      <section class="panel">
        <h2 class="section-title">Combat</h2>
        <div class="grid g-3">
          <div>
            <label>Wound Boxes:
              <input type="number" step="1" min="0" data-bind="combat.woundBoxes" />
            </label>
            <div class="kpi" style="margin-top:6px"><div class="muted">Total</div><div class="value" data-out="woundTotal">0</div></div>
            <div class="tiny">Formula: (HP Ã— 2) âˆ’ HP Bonus</div>
          </div>
          <div>
            <label>Temp. Wound Boxes:
              <input type="number" step="1" min="0" data-bind="combat.tempWounds" />
            </label>
          </div>
          <div>
            <label>Battery:
              <input type="number" step="1" min="0" data-bind="combat.batteryManual" />
            </label>
            <div class="kpi" style="margin-top:6px"><div class="muted">Total</div><div class="value" data-out="batteryTotal">0</div></div>
            <div class="tiny">Formula: Stage + 1</div>
          </div>
        </div>
      </section>
    `);
    root.appendChild(combatPanel);

    // Stats
    const statsPanel = el(`<section class="panel">
      <h2 class="section-title">Stats</h2>
      <div class="grid g-5" id="statsGrid"></div>
    </section>`);
    root.appendChild(statsPanel);

    const statOrder = ['ACC','DOD','DAM','ARM','HP'];
    const statsGrid = statsPanel.querySelector('#statsGrid');
    statOrder.forEach(k=>{
      const card = el(`<div class="stat-card" data-stat="${k}">
        <div class="stat-total" data-out="stat:${k}">0</div>
        <div class="stat-name">${k}</div>
        <label>DP:
          <input type="number" step="1" min="0" data-bind="stats.${k}.dp" />
        </label>
        <label>Bonus:
          <input type="number" step="1" data-bind="stats.${k}.bonus" />
        </label>
        <div class="tiny">Total = Stage + DP + Bonus</div>
      </div>`);
      statsGrid.appendChild(card);
    });

    // Derived Stats
    const derivedPanel = el(`<section class="panel">
      <h2 class="section-title">Derived Stats</h2>
      <div class="grid g-4" id="derivedGrid"></div>
      <div class="note" style="margin-top:6px">Total = âŒŠAssociated Stat Ã· 3âŒ‹ + Bonus, plus Size bonus. Size bonuses: Small/Medium â†’ +1 BIT & RAM; Large â†’ +1 BIT & CPU; Huge/Enormous/Gigantic â†’ +1 DOS & CPU.</div>
    </section>`);
    root.appendChild(derivedPanel);

    const derivedOrder = ['BIT','RAM','DOS','CPU'];
    const derivedGrid = derivedPanel.querySelector('#derivedGrid');
    derivedOrder.forEach(k=>{
      const base = derivedBase[k];
      const card = el(`<div class="stat-card" data-derived="${k}">
        <div class="stat-total" data-out="derived:${k}">0</div>
        <div class="stat-name">${k} <span class="tiny">(from ${base})</span></div>
        <label>Bonus:
          <input type="number" step="1" data-bind="derived.${k}.bonus" />
        </label>
      </div>`);
      derivedGrid.appendChild(card);
    });

    // Attacks
    const attacksPanel = el(`<section class="panel">
      <h2 class="section-title">Attacks</h2>
      <div class="badge">SIGNATURE MOVE</div>
      <div id="attacks"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="addAttack">âž• Add Attack</button>
      </div>
    </section>`);
    root.appendChild(attacksPanel);

    const attacksBox = attacksPanel.querySelector('#attacks');
    function renderAttackRow(idx){
      const a = data.attacks[idx];
      const row = el(`<div class="attack-row" data-idx="${idx}">
        <label>Name<input type="text" data-attack="name"></label>
        <label>Range<select data-attack="range"><option>Melee</option><option>Ranged</option></select></label>
        <label>Kind<select data-attack="type"><option>Damage</option><option>Support</option></select></label>
        <label>Acc.<input type="number" step="1" data-attack="acc"></label>
        <label class="dmg">Dmg<input type="number" step="1" data-attack="dmg"></label>
        <label class="taglabel">Tag 1<input type="text" data-attack="tag0"></label>
        <label class="taglabel">Tag 2<input type="text" data-attack="tag1"></label>
        <label class="taglabel">Tag 3<input type="text" data-attack="tag2"></label>
        <button class="btn danger x" title="Delete">âœ•</button>
      </div>`);
      // bind values
      row.querySelector('[data-attack="name"]').value = a.name||'';
      row.querySelector('[data-attack="range"]').value = a.range||'Melee';
      row.querySelector('[data-attack="type"]').value = a.type||'Damage';
      row.querySelector('[data-attack="acc"]').value = a.acc||0;
      row.querySelector('[data-attack="dmg"]').value = a.dmg||0;
      row.querySelector('[data-attack="tag0"]').value = a.tags?.[0]||'';
      row.querySelector('[data-attack="tag1"]').value = a.tags?.[1]||'';
      row.querySelector('[data-attack="tag2"]').value = a.tags?.[2]||'';

      const dmgLabel = row.querySelector('.dmg');
      function toggleDmg(){ dmgLabel.style.display = (row.querySelector('[data-attack="type"]').value==='Support') ? 'none' : 'block'; }
      toggleDmg();

      row.addEventListener('input', (e)=>{
        const t = e.target.getAttribute('data-attack');
        if(!t) return;
        if(t.startsWith('tag')){
          const i = Number(t.slice(3));
          a.tags = a.tags || ['','',''];
          a.tags[i] = e.target.value;
        } else if(t==='name' || t==='range' || t==='type'){
          a[t] = e.target.value;
          if(t==='type') toggleDmg();
        } else if(t==='acc' || t==='dmg'){
          a[t] = Number(e.target.value)||0;
        }
      });

      row.querySelector('.x').onclick = ()=>{
        if(idx===0){ alert('Signature Move row cannot be removed.'); return; }
        data.attacks.splice(idx,1);
        refreshAttacks();
      };

      return row;
    }

    function refreshAttacks(){
      attacksBox.innerHTML = '';
      data.attacks.forEach((_,i)=> attacksBox.appendChild(renderAttackRow(i)) );
    }
    refreshAttacks();
    attacksPanel.querySelector('#addAttack').onclick = ()=>{
      data.attacks.push({name:'', range:'Melee', type:'Damage', acc:0, dmg:0, tags:['','','']});
      refreshAttacks();
    };

    // DP Allocation
    const dpPanel = el(`<section class="panel">
      <h2 class="section-title">DP Allocation</h2>
      <div class="grid g-3">
        <div>
          <label>Quality DP:
            <input type="number" step="1" min="0" data-bind="dp.quality" />
          </label>
        </div>
        <div>
          <div class="muted">Stat DP:</div>
          <div class="kpi"><div class="value" data-out="statDP">0</div></div>
        </div>
        <div>
          <label>Bonus DP:
            <input type="number" step="1" data-bind="dp.bonus" />
          </label>
        </div>
      </div>
      <div class="row" style="margin-top:10px; align-items:center">
        <div class="muted">Total DP:</div>
        <div class="kpi"><div class="value"><span class="fraction"><span class="num" data-out="spentDP">0</span><span data-out="totalDP">0</span></span></div></div>
      </div>
    </section>`);
    root.appendChild(dpPanel);

    // Qualities
    root.appendChild(el(`
      <section class="panel">
        <h2 class="section-title">Qualities</h2>
        <label>
          <textarea rows="8" data-bind="qualities" placeholder="Write qualities and descriptions here..."></textarea>
        </label>
      </section>
    `));

    // Bind logic for all inputs
    root.addEventListener('input', (e)=>{
      const path = e.target.getAttribute('data-bind');
      if(path){
        setByPath(data, path, coerce(e.target.value));
        compute();
      }
    });

    // Initialize values
    // populate inputs from data
    root.querySelectorAll('[data-bind]').forEach(input=>{
      const path = input.getAttribute('data-bind');
      const v = getByPath(data, path);
      // For selects and inputs, assign value if present
      if(typeof v !== 'undefined' && v !== null) input.value = v;
    });

    // selects in basic info
    root.querySelectorAll('select[data-bind]').forEach(sel=>{
      sel.addEventListener('change', ()=> compute());
    });

    function compute(){
      // stat totals
      statOrder.forEach(k=>{
        const out = root.querySelector(`[data-out="stat:${k}"]`);
        if(out) out.textContent = statTotal(k);
      });
      // derived
      derivedOrder.forEach(k=>{
        const out = root.querySelector(`[data-out="derived:${k}"]`);
        if(out) out.textContent = derivedTotal(k);
      });
      // combat
      setOut('woundTotal', woundTotal());
      setOut('batteryTotal', batteryTotal());
      // dp
      setOut('statDP', statDPSum());
      setOut('spentDP', spentDP());
      setOut('totalDP', totalAllocDP());
    }

    function setOut(dataAttr, value){
      const el = root.querySelector(`[data-out="${dataAttr}"]`);
      if(el) el.textContent = value;
    }

    compute();

    // Expose a serialize method on the element for saving
    root.__getData = ()=> JSON.parse(JSON.stringify(data));
    root.__setData = (payload)=>{
      data = Object.assign(data, payload||{});
      // push values into controls
      root.querySelectorAll('[data-bind]').forEach(input=>{
        const path = input.getAttribute('data-bind');
        const v = getByPath(data, path);
        if(typeof v !== 'undefined' && v !== null) input.value = v;
      });
      refreshAttacks();
      compute();
    };

    return root;
  }

  // Tiny DOM helpers
  function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }
  function coerce(v){ if(v==='' || v==null) return ''; const n=Number(v); return Number.isNaN(n)? v : n }
  function getByPath(obj, path){ return path.split('.').reduce((o,k)=> (o? o[k] : undefined), obj) }
  function setByPath(obj, path, val){ const parts=path.split('.'); let o=obj; parts.forEach((k,i)=>{ if(i===parts.length-1) o[k]=val; else { o[k]=o[k]||{}; o=o[k]; } }); }

  // Save/Open
  function activeSheet(){ const id=state.active; if(!id) return null; return document.querySelector(`.sheet[data-id="${id}"]`) }

  saveBtn.onclick = ()=>{
    const sheet = activeSheet();
    if(!sheet){ alert('No active sheet to save.'); return; }
    const tab = state.tabs.find(t=>t.id===state.active);
    const name = prompt('Save name:', tab?.title || 'Untitled Digimon');
    if(!name) return;
    const payload = {
      id: tab.id,
      type: tab.type,
      title: name,
      data: sheet.firstElementChild.__getData?.()
    };
    const key = `digi2e:${name}`;
    localStorage.setItem(key, JSON.stringify(payload));
    // update tab title
    const tabEl = [...tabBar.children].find(e=>e.dataset.id===tab.id);
    if(tabEl) tabEl.firstElementChild.textContent = `ðŸ“„ ${name}`;
    tab.title = name;
    alert('Saved!');
  };

  openBtn.onclick = ()=>{
    openList.innerHTML = '';
    Object.keys(localStorage).filter(k=>k.startsWith('digi2e:')).sort().forEach(key=>{
      try{
        const payload = JSON.parse(localStorage.getItem(key)||'null');
        if(!payload) return;
        const card = el(`<div class="panel">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div>
              <div style="font-family:Orbitron; font-weight:700">${payload.title||'(no title)'}</div>
              <div class="tiny">${key}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="open">Open</button>
              <button class="btn danger" data-act="delete">Delete</button>
            </div>
          </div>
        </div>`);
        card.querySelector('[data-act="open"]').onclick = ()=>{
          const id = addTab(payload.title||'Digimon', payload.type||'digimon', payload.data||{});
          openModal.classList.add('hidden');
          activateTab(id);
        };
        card.querySelector('[data-act="delete"]').onclick = ()=>{
          if(confirm('Delete saved sheet "'+(payload.title||key)+'"?')){
            localStorage.removeItem(key); card.remove();
          }
        };
        openList.appendChild(card);
      } catch{}
    });
    openModal.classList.remove('hidden');
  };

  // New Modal wiring
  newBtn.onclick = ()=> newModal.classList.remove('hidden');
  document.querySelectorAll('[data-newtype]').forEach(b=> b.onclick = ()=>{
    const type = b.getAttribute('data-newtype');
    if(type==='digimon') addTab('New Digimon','digimon');
    else addTab('New Tamer','tamer');
    newModal.classList.add('hidden');
  });
  closeNew.onclick = ()=> newModal.classList.add('hidden');
  closeOpen.onclick = ()=> openModal.classList.add('hidden');

  // Start with a fresh Digimon sheet
  addTab('New Digimon','digimon');
})();
</script>
</body>
</html>
