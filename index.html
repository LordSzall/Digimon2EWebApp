<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDA2E - Character Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="grid-bg"></div>
  <header>
    <div class="brand">DIGIMON DIGITAL ADVENTURES 2ND EDITION</div>
    <div class="spacer"></div>
    <button class="btn" id="newBtn" title="Create new sheet">âž• New</button>
    <button class="btn" id="saveBtn" title="Save active sheet">ðŸ’¾ Save</button>
    <button class="btn" id="openBtn" title="Open saved sheet">ðŸ“‚ Open</button>
    <button class="btn" id="exportBtn" title="Export sheet to file">ðŸ“¤ Export</button>
    <button class="btn" id="importBtn" title="Import sheet from file">ðŸ“¥ Import</button>
  </header>

  <div class="container">
    <div class="tabs" id="tabBar"></div>
    <div class="sheets" id="sheets"></div>
  </div>

  <!-- New Modal -->
  <div class="modal hidden" id="newModal">
    <div class="box">
      <h3>Create New Sheet</h3>
      <div class="row modal-options">
        <button class="btn" data-newtype="tamer">Tamer</button>
        <button class="btn primary" data-newtype="digimon">Digimon</button>
      </div>
      <div class="help">Choose sheet type. A new tab will be added below the toolbar.</div>
      <div class="row modal-footer">
        <button class="btn" id="closeNew">Close</button>
      </div>
    </div>
  </div>

  <!-- Open Modal -->
  <div class="modal hidden" id="openModal">
    <div class="box">
      <h3>Open Saved Sheets</h3>
      <div id="openList" class="grid g-6"></div>
      <div class="row modal-footer">
        <button class="btn" id="closeOpen">Close</button>
      </div>
    </div>
  </div>

  <!-- Import Progress Modal -->
  <div class="modal hidden" id="importModal">
    <div class="box">
      <h3>Import Sheet</h3>
      <div class="import-status">
        <div class="help" id="importStatus">Select a .dda2e or .json file to import...</div>
      </div>
      <div class="row modal-footer">
        <button class="btn" id="closeImport">Close</button>
      </div>
    </div>
  </div>

  <!-- New Quality Modal -->
  <div class="modal hidden" id="qualityModal">
    <div class="box">
      <h3 id="qualityModalTitle">Quality Editor</h3>
      <div class="grid g-2">
        <label>Name
          <input type="text" id="qualityName" placeholder="Quality name..." />
        </label>
        <label>DP Cost
          <input type="number" id="qualityDP" min="0" value="1" />
        </label>
      </div>
      <div class="grid g-2">
        <label>Stage
          <select id="qualityStage">
            <option value="Any">Any Stage</option>
            <option value="Child">Child</option>
            <option value="Adult">Adult</option>
            <option value="Perfect">Perfect</option>
            <option value="Ultimate">Ultimate</option>
          </select>
        </label>
        <label>Type
          <select id="qualityType">
            <option value="Static">Static</option>
            <option value="Attack">Attack</option>
            <option value="Trigger">Trigger</option>
          </select>
        </label>
      </div>
      <label>Description
        <textarea id="qualityDescription" rows="6" placeholder="Describe the quality's effects...

  Formatting tips:
  - Use **text** for bold
  - Press Enter for line breaks"></textarea>
      </label>
      <!-- NEW: Live preview -->
      <div class="quality-preview">
        <div class="quality-preview-label">Preview:</div>
        <div id="qualityDescriptionPreview" class="quality-preview-content">
          Type in the description above to see a preview...
        </div>
      </div>
      <div class="row modal-footer">
        <button class="btn" id="cancelQuality">Cancel</button>
        <button class="btn primary" id="confirmQuality">Add Quality</button>
      </div>
    </div>
  </div>

  <!-- Quality Detail Modal -->
  <div class="modal hidden" id="qualityDetailModal">
    <div class="box">
      <h3 id="qualityDetailTitle">Quality Name</h3>
      <div class="quality-stage-badge" id="qualityDetailStage">Any Stage</div>
      <div class="quality-type-badge" id="qualityDetailType">Static</div>
      <div class="quality-dp-cost" id="qualityDetailDP">Cost: 1 DP</div>
      <div class="hr"></div>
      <div class="quality-description-container">
        <div id="qualityDetailDescription">Quality description will appear here...</div>
      </div>
      <div class="row modal-footer">
        <button class="btn" id="exportQuality">ðŸ“¤ Export</button>
        <button class="btn" id="editQuality">Edit</button>
        <button class="btn" id="closeQualityDetail">Close</button>
      </div>
    </div>
  </div>

  <!-- NEW: Quality Import Modal -->
  <div class="modal hidden" id="qualityImportModal">
    <div class="box quality-import-box">
      <h3>Import Quality from Library</h3>

      <!-- Search and Filter Controls -->
      <div class="quality-import-controls">
        <div class="grid g-3">
          <label>Search
            <input type="text" id="qualitySearchInput" placeholder="Search qualities..." />
          </label>
            <label>Filter by Stage
                <select id="qualityFilterStage">
                    <option value="">All Stages</option>
                    <option value="Child">Child</option>
                    <option value="Adult">Adult</option>
                    <option value="Perfect">Perfect</option>
                    <option value="Ultimate">Ultimate</option>
                    <option value="Any">Any Stage</option>
                </select>
            </label>
          </label>
          <label>Filter by Type
            <select id="qualityFilterType">
              <option value="">All Types</option>
              <option value="Attack">Attack</option>
              <option value="Static">Static</option>
              <option value="Trigger">Trigger</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Quality Library Grid -->
      <div class="quality-library-container">
        <div id="qualityLibraryGrid" class="quality-library-grid"></div>
      </div>

      <!-- Status -->
      <div class="quality-import-status">
        <div class="help" id="qualityImportStatus">Loading quality library...</div>
      </div>

      <!-- Footer -->
      <div class="row modal-footer">
        <button class="btn" id="closeQualityImport">Close</button>
      </div>
    </div>
  </div>

  <script src="utils.js"></script>
  <script src="tab-manager.js"></script>
  <script src="special-orders.js"></script>
  <script src="tamer-sheet.js"></script>
  <script src="digimon-sheet.js"></script>
  <script src="quality-library.js"></script>
  <script src="save-load.js"></script>
  <script src="main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const descInput = document.getElementById('qualityDescription');
      const preview = document.getElementById('qualityDescriptionPreview');

      if (descInput && preview) {
        // Update preview on input
        descInput.addEventListener('input', () => {
          const text = descInput.value;
          if (!text.trim()) {
            preview.innerHTML = 'Type in the description above to see a preview...';
            preview.style.opacity = '0.6';
          } else {
            preview.innerHTML = window.QualityFormatter ?
              window.QualityFormatter.formatDescription(text) :
              text.replace(/\n/g, '<br>');
            preview.style.opacity = '1';
          }
        });
      }
    });
  </script>
</body>
</html>
